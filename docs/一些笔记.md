## gamma矫正

部分人认为是由于早期 CRT 显示器的问题，即输出的亮度和输入的电压并非线性关系，而是近似 2.2 次幂的关系，导致进入人眼的亮度要比计算机上存储的亮度要低。例如，计算机上存储的亮度为 0.5，经过显示器调整后变为 0.5 的 2.2 次幂，即 0.218。为了让进入人眼的亮度与计算机中存储的值相同，需要在显示器调整前将亮度变为自身的 1/2.2 次幂，即 0.73，这样在经过显示器的调整，进入人眼就是 0.5 了，也就是说，Gamma 校正可以补偿由于显示器造成的亮度下降。这里需要注意的是，2.2 这个值是一个近似值，或者可以说是一个标准，实际上可能会有不同，现在的显示器甚至可以调节。
https://zhuanlan.zhihu.com/p/36581276

一般真实渲染最后一步是要做gamma矫正的，有些引擎不注重真实渲染的话，就不做了。

### SRGB与线性空间

https://zhuanlan.zhihu.com/p/66558476

### 关于shadowMap中的自遮挡问题

最简单的shadowMap结果出来的画面锯齿很明显，是因为深度纹理的一个个深度是离散的，第二次pass时多个片元虽然深度不同，但都会对于同一个深度纹理中的纹素，当视角倾斜时，效果尤为明显，显示出一条一条的锯齿。
在第一次pass中对所有的顶点的z值加上bias偏移量，使得深度纹理往后推，这样第二次比较的时候就容易比之前深度小，所有避免了锯齿的发生。但是这个bias如果移的很大，就会发生peterpan的现象。
只是添加bias仍然不能解决另外一些场景，如正对着灯光的球体，球体两边是有锯齿的。这时候应该有个按法线和光线方向的bias计算，使得第一次pass中的各个顶点的xyz按法线方向收缩，可以想象，球体对两侧进行收缩，两侧空出来的区域深度会显著加大，这也就让原有的两侧在渲染时深度明显小于SM上的深度，从而处于光照之下。

### sampler2DShadow

要使用 sampler2DShadow，需要做两件事。第一，需要开启比较模式，否则会行为未定义。有 sampler 或者 texture 属性 GL_TEXTURE_COMPARE_MODE = GL_COMPARE_REF_TO_TEXTURE，还需要设定比较方式，与深度测试设置参数方法相同。第二，texture 函数采样输入值为三维变量，前面两个值与纹理坐标无异，第三个坐标为待比较的深度值。
对 sampler2DShadow 使用 texture 后返回的值在 0.0 和 1.0 之间。如果设定的采样滤波为 nearest，则比较测试通过返回 1.0，否则返回 0.0；如果设定的采样滤波为 linear，则会选取采样点最近的四个像素，分别进行深度比较，可能返回 0.0、0.25、0.50、0.75、1.0 等值，表示通过测试和总像素数的比值。
其实使用线性滤波时， sampler2DShadow 比通常的 sampler2D 可以达到更好的抗锯齿效果。因为，sampler2DShadow 表示四个点的比值，而 sampler2D 只能得到一个单一的平均深度和一个布尔型，这对阴影锯齿来说并不理想。

### PCF
个人理解PCF核心在于平均化，不再是传统与深度图比较产生的true和false。例如，使用sampler2DShadow加上线性纹理过滤，会与4个点进行比较，返回0-1之间的插值（4个中有几个通过？）

深度纹理什么时候用颜色缓冲区？什么时候用深度缓冲？需要自己比较的时候用颜色缓冲，GPU硬件比较返回值的时候用深度缓冲，如sampler2DShadow类型

### 基于高斯卷积的PCF
基于sampler2DShadow的双线性插值采样，实际一个采样点考虑到了周围四个点，因此，基于高斯卷积核重新计算各个采样点的偏移量以及对应的权重值，构建一个新的卷积核。
0 0 0 0 0 0 0
0 1 3 4 3 1 0
0 3 9 12 9 3 0
0 4 12 16 12 4 0    
0 3 9 12 9 3 0
0 1 3 4 3 1 0
0 0 0 0 0 0 0
该5*5的卷积核，如根据采样点的偏移量算出左上角 0 0 的权重k，该k值是这四个点的线性插值。
                                         0 1                                                                                                       
                                                                         
0 0 0 
0 1 3 
0 3 9  算出四个k后，则计算uv的具体偏移量和对应权重值。

对应公式：
 (k[x, y] == (1 - u) (1 - v) w)
 (k[x + 1, y] == u (1 - v)*w)
 (k[x, y + 1] == (1 - u) v*w)
 (k[x + 1, y + 1] == u*v*w)

![Alt text](images/%E5%AF%B9%E4%BA%8E%E9%AB%98%E6%96%AF%E5%8D%B7%E7%A7%AFPCF%E7%9A%84%E4%B8%AA%E4%BA%BA%E7%90%86%E8%A7%A3%E5%9B%BE.png)


### CSM
1. 相机视锥体分割
2. 对分割后的视锥体求取包围盒
3. 由包围盒计算灯光的左右、上下、前后两个面，从而计算灯光正交投影矩阵
4. ShadowMap渲染
5. 级联选择

传统计算包围盒是计算视锥体最紧的矩形包围盒，该包围盒的计算方法优点是贴图利用率高，视锥体填满了整个深度贴图，但是缺点是随着视锥体或者灯光移动，近平面的大小会发生改变，因此深度贴图的
分辨率也会发生改变，产生阴影闪屏（swimm）的现象。
为了改善此现象，引入了stabilize CSM。
对于视锥体的旋转：采用了计算视锥体包围球的计算方式，当视锥体或者灯光怎么转时，球的大小是不变的，因此贴图分辨率不变。包围球的计算可以使用简单的求出中心点，算最大半径的方式。也可以使用能得到更加紧凑边界的标准算法。
对于视锥体的平移：采用偏移投影矩阵，保证相机移动前和移动后，世界空间中的同一点都能投影到相同纹理贴图上。

注意：CSM只适用于平行光

### 数组纹理与离屏渲染连接

gl.createFrameBuffer()
gl.bindFrameBuffer(gl.FRAMEBUFFER, fbo)

gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D_ARRAY, colorTexture);
gl.texImage3D(gl.TEXTURE_2D_ARRAY, 0, gl.RGBA, width, height, layers, border, gl.RGBA, type, null);
gl.texParameteri(gl.TEXTURE_2D_ARRAY,...)

gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D_ARRAY, depthTexture);
gl.texImage3D(gl.TEXTURE_2D_ARRAY, 0, gl.DEPTH_COMPONENT,, width, height, layers, border, gl.DEPTH_COMPONENT,, type, null);
gl.texParameteri(gl.TEXTURE_2D_ARRAY,...)

gl.bindFrameBuffer(gl.FRAMEBUFFER, fbo)
for(let i =0; i<layers,i++){
gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, colorTexture, 0, i)
gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, depthTexture, 0, i)
gl.clear(depth,color);
render()...
}

### pbr中irradiance部分

在IBL的漫反射阶段，其漫反射渲染方程如下：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/279538ab-afea-439d-9a52-cb21b655857f.png)

由于被积分函数只和入射方向有关，因此这块可以预计算成irradianceMap。

由于漫反射可以考虑是各个方向的，因此可以简单在半球面上均匀采样。

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/a894c6b6-e210-4110-808c-5eb5096300c8.png)

为了减少样本的采样数量，提高收敛速度，考虑PDF，即概率密度函数的曲线应该和被积函数的曲线差不太多，在重要的地方（PDF大）多采样，在其他不重要（PDF小）的地方少采样。

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/a0167e60-58bf-4221-bc2a-3c581d1eb215.png)

图一是均匀采样，PDF是个常数，图二是PDF曲线和被积函数差不多的重要性采样。

仔细观察被积函数，，有个n\*w，也就是有个$cos\theta$项，就是说明被积函数受cos这个曲线进行加权，因此考虑PDF与cos曲线有关系，简单的相当PDF与cos正相关，即：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/c37752a6-1a99-499d-808e-0a0753c6179d.png)

即，$p(\omega) = c \* cos\theta$。怎么确定这个c值呢，pdf有个性质，就是其积分在区间内等于1，利用这个条件，可以计算出c值;

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/a173c44f-3314-40d9-a6d3-0e59ae6d797e.png)

c = ${1 \over \pi}$

即：![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/d51779b6-b59d-4622-83ee-93c8688bfae0.png)

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/58313ffc-4cc6-42d2-bee7-2e8d0ee45a08.png)

这被称为余弦权重的半球采样。

实际写代码时，我们要输入一系列随机点，这可以通过使用hammersley低差异采样实现，得出一个二维的在【0，1】之间的两个数。现在要把二维的点变为方向wi，wi是xyz表示的向量，在球坐标系，也可以通过$\theta$、$\phi$得到，因此，需要将随机点【0-1】转变为$\theta$、$\phi$。有了p(w)，我们还要求出p($\theta$,$\phi$)。

根据立体角：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/aa23f8d1-552b-4a53-8a85-ef647d6e7ae2.png)

得出：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/a38f189d-62d2-494a-872e-5a7566a6f6bd.png)

下面要求边缘密度函数mdf：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/97eb2340-46c0-48fa-9a37-ad3c2a9d8896.png)

条件密度函数CDF：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/b136bd39-94cd-4430-b8cc-9eb7f464bdcb.png)

累积分布函数，是PDF的积分：描述的是在此区间的概率：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/fcff8de4-b516-43c9-b82a-6f9b519324e5.png)

累积分布函数的值对应的就是随机二维点$\zeta$，利用反函数求出对应的$\theta$、$\phi$。

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/d5c64520-69f8-42b7-912e-860805ddad86.png)

利用球面坐标到直角坐标的转换，求出xyz值，继而表示wi的向量：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/cace5b7e-0a8c-4120-b771-636b2e195b43.png)

余弦权重的半球采样只考虑了PDF本身去做重要性，忽略了IBL的贴图的实际内容。如果后者在没有大量样本的区域包含高频，则积分将不准确。其次，使用同样序列的拟随机数会造成走样如下图a，一般解决方法是在蒙特卡洛中引入随机性来转变为可接受的噪点，但采样次数会上升，如下图b。

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/ff1befa9-921b-4463-bca2-b953f4988955.png)

因此，我们希望：

*   如果一个样本方向的PDF很**小**，则不太可能在类似的方向上生成其他样本。在这种情况下，我们希望样本能够从环境贴图中获得**大面积**的平均光照，从而提供一个更好的整体的近似值。
    
*   如果一个方向的PDF非常**大**，很多样本可能会在相似的方向上生成。因此，多个样本将有助于从该区域平均积分估计的误差。在这种情况下，样本应该只对环境贴图的**一小块区域**进行平均。
    

重点在于：**平均**

**怎么做到平均？卷积核或者mipmap。**

mipmap求解LOD的level，就是最核心的。用：${ 根据pdf计算的需要采样的立体角范围 \over mip0级的环境贴图上的一个像素对应的立体角 }$这个比值决定了需要采样mip0的像素数，如果才需要采样4个，就去level = 4的mipmap去采样像素，也就是4个平均值。

这也是babylon的漫反射irrdaiance部分的计算方式。

参考：[https://zhuanlan.zhihu.com/p/338569782](https://zhuanlan.zhihu.com/p/338569782)

[https://zhuanlan.zhihu.com/p/633079678](https://zhuanlan.zhihu.com/p/633079678)

### 利用球谐计算IBL中漫反射部分

抓住两点：投影与重建
环境光L是一个函数，可以用球谐函数来表示，L等于一系列球谐系数与球谐基函数相乘相加。
1. 计算系数。系数等于原函数在基函数上的投影
2. 重建函数，函数可以由一系列球谐系数与球谐基函数相乘相加组合。

传统的irradianceMap需要额外保存一张纹理，占用了一定的带宽，对移动端来说有点吃不消。irradianceMap实际上也可以看作是环境贴图的卷积后的结果，是去除高频信息后的纹理。而球谐函数前几阶正是对高频信息的去除，故可以用球谐函数来计算pbr中漫反射diffuse项。

一个球面函数可以用一系列球谐基函数进行广义傅里叶展开，这个过程称之为“重建”。表示为：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/9d2cea58-493a-439f-8bc5-9fe9f88457d3.png)

其中，系数$C\_l^m$可以通过原函数与对应球谐基函数相乘在球面上的积分表示出来：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/b0cdee9b-3bdf-4319-8874-6005377fb08a.png)

求系数的过程，称之为“投影”。可以想象一个三维向量分别在X轴、Y轴、Z轴的投影，实际上是将这个向量与X轴相乘求系数。

PBR的漫反射公式中：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/5a259099-37e4-470f-9f31-7c24770a9eb3.png)

由两部分组成，一部分是光照函数L，另外一部分是传递函数cos项，这两个函数分别以球谐函数为基底进行展开。

光照L展开式：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/5b91b422-4c0a-4a0f-8c14-fa4f9e350c55.png)

光照函数的球谐系数则表示为：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/a4de193d-d5d1-4bf1-98e0-0e2be37f9cb6.png)

传递函数cos，令A=cos，则表示为：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/73743af1-ec87-4d4c-a1a9-72438f5a60ee.png)

最终，漫反射E可以推到为：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/131592fd-8ef2-4986-923e-1283cf96855b.png)

由最终公式可以看出，我们要求出光照函数L的系数$L\_l^m$，传递函数A的系数$A\_l^0$。这两部分以及前面的根号下的常数以及Y中的系数我们可以预先求出，传入这些系数到着色器中，乘上法向量n，就是最终的E了。

下面就是求系数了。

计算光照函数L的系数$L\_l^m$：

实际上要对cubemap这张环境贴图求系数，根据公式，遍历cubemap的6个面，每个面遍历其尺寸，求出xy对应下的颜色值，即L项，再计算这一个纹素对应在球面上的立体角w，再乘上球谐基函数Y，不断累加。

计算传递函数A的系数$A\_l^0$：

以三阶球谐为例：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/760ec2b0-74a3-4da7-8a20-9f8882a9eb46.png)

球谐基函数Y计算如下：

![image](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/2M9qPJJWDZgYl015/img/c9ea1039-109a-43b1-b551-e1ed566c19d9.png)

在预计算中，我们将这些常数都预先乘号，包括最终的Y中的系数也是提前乘上，最后传入着色器中，与各xyz法向量做相应组合就行。

